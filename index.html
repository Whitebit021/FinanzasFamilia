<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Presupuesto Familiar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .progress-bar { transition: width 0.5s ease-in-out; }
        input:disabled { background-color: #334155 !important; cursor: not-allowed; }
        .modal-hidden { display: none; }
    </style>
</head>
<body class="bg-slate-900 text-white flex items-center justify-center min-h-screen p-4 sm:p-6">

    <!-- Contenedor Principal -->
    <div class="w-full max-w-2xl mx-auto">

        <!-- Pantalla de Autenticación -->
        <div id="auth-container" class="space-y-6">
            <header class="text-center"><h1 class="text-3xl sm:text-4xl font-bold text-cyan-400">Finanzas Familiares</h1><p class="text-slate-400 mt-1">Inicia sesión o regístrate para empezar.</p></header>
            <div class="bg-slate-800 p-6 rounded-xl shadow-lg"><form id="login-form"><h3 class="text-xl font-semibold mb-4 text-white">Iniciar Sesión</h3><div class="space-y-4"><input type="email" id="login-email" placeholder="Correo electrónico" required class="w-full bg-slate-900 p-3 rounded-lg"><input type="password" id="login-password" placeholder="Contraseña" required class="w-full bg-slate-900 p-3 rounded-lg"><button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 font-bold py-3 rounded-lg">Entrar</button></div></form><p class="text-center text-sm text-slate-400 mt-4">¿No tienes cuenta? <a href="#" id="show-register" class="font-semibold text-cyan-400">Regístrate</a></p></div>
            <div id="auth-error" class="text-center text-red-400 text-sm h-4"></div>
        </div>
        
        <!-- Pantalla de Selección de Familia -->
        <div id="family-container" class="hidden space-y-4 text-center">
             <header class="text-center"><p class="text-slate-400">Usuario:</p><p id="family-user-email" class="font-semibold text-cyan-300"></p></header>
             <div class="bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-cyan-400 mb-4">¡Hola!</h2>
                <button id="create-family-btn" class="w-full bg-green-600 hover:bg-green-700 font-bold py-3 rounded-lg">Crear Nuevo Espacio Familiar</button>
                <p class="text-slate-400 my-4">o</p>
                <form id="join-family-form" class="flex space-x-2"><input type="text" id="join-family-id" placeholder="Ingresa ID de Familia" required class="w-full bg-slate-900 p-3 rounded-lg"><button type="submit" class="bg-blue-600 hover:bg-blue-700 font-bold py-3 px-4 rounded-lg">Unirse</button></form>
            </div>
        </div>

        <!-- Contenedor de la Aplicación -->
        <div id="app-container" class="hidden space-y-6">
            <header class="flex justify-between items-center">
                <div><p class="text-sm text-slate-400">Familia ID:</p><p id="family-id-display" class="font-mono cursor-pointer" title="Click para copiar"></p></div>
                <button id="logout-btn" class="text-sm bg-red-600 hover:bg-red-700 font-bold py-2 px-4 rounded-lg">Salir</button>
            </header>
            
            <section class="bg-slate-800 p-5 rounded-xl shadow-lg">
                <h2 class="text-lg font-semibold mb-4 text-slate-300">Resumen del Mes</h2>
                <div class="mb-4"><label class="block text-sm font-medium text-cyan-300">Presupuesto Mensual (COP)</label><input type="number" id="monthly-budget" placeholder="Define un presupuesto..." class="w-full mt-1 bg-slate-900 p-2 text-xl rounded-lg"></div>
                <div class="space-y-3"><div class="flex justify-between items-end"><span class="text-slate-400">Gastado:</span><span id="total-spent" class="font-bold text-lg text-amber-400">$0</span></div><div class="flex justify-between items-end"><span id="remaining-label" class="text-slate-400">Restante:</span><span id="remaining-budget" class="font-bold text-2xl text-green-400">$0</span></div></div>
                <div class="w-full bg-slate-700 rounded-full h-4 mt-4 overflow-hidden"><div id="progress-bar" class="progress-bar h-4 rounded-full"></div></div>
            </section>

            <section class="bg-slate-800 p-5 rounded-xl shadow-lg">
                <h2 class="text-lg font-semibold mb-4 text-slate-300">Añadir Nuevo Gasto</h2>
                <form id="add-expense-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="sm:col-span-2"><label for="expense-amount" class="block text-sm">Monto (COP)</label><input type="number" id="expense-amount" required class="w-full mt-1 bg-slate-900 p-2 rounded-lg"></div>
                    <div><label for="expense-store" class="block text-sm">Tienda / Descripción</label><input type="text" id="expense-store" required class="w-full mt-1 bg-slate-900 p-2 rounded-lg"></div>
                    <div><label for="payment-method" class="block text-sm">Medio de Pago</label><select id="payment-method" class="w-full mt-1 bg-slate-900 p-2 rounded-lg"><option>Tarjeta de Crédito</option><option>Otro</option></select></div>
                    <button type="submit" class="sm:col-span-2 w-full bg-cyan-600 hover:bg-cyan-700 font-bold py-3 rounded-lg">Añadir Gasto</button>
                </form>
            </section>
            
            <section class="bg-slate-800 p-5 rounded-xl shadow-lg">
                <h2 class="text-lg font-semibold mb-4 text-slate-300">Historial de Gastos</h2>
                <div id="expense-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
            </section>
        </div>
    </div>

<script type="module">
    // --- IMPORTACIONES DE FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, collection, onSnapshot, setDoc, addDoc, deleteDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIGURACIÓN ---
    let firebaseConfig = { /* PEGA TU CONFIGURACIÓN DE FIREBASE AQUÍ */ };
    if (!firebaseConfig.apiKey && typeof __firebase_config !== 'undefined') { firebaseConfig = JSON.parse(__firebase_config); }

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // --- DOM ELEMENTS ---
    const authContainer = document.getElementById('auth-container');
    const familyContainer = document.getElementById('family-container');
    const appContainer = document.getElementById('app-container');
    // ... (resto de elementos del DOM)
    const loginForm = document.getElementById('login-form');
    const loginEmailInput = document.getElementById('login-email');
    const loginPasswordInput = document.getElementById('login-password');
    const showRegisterLink = document.getElementById('show-register');
    const authErrorEl = document.getElementById('auth-error');
    const logoutBtn = document.getElementById('logout-btn');
    const familyUserEmail = document.getElementById('family-user-email');
    const createFamilyBtn = document.getElementById('create-family-btn');
    const joinFamilyForm = document.getElementById('join-family-form');
    const joinFamilyIdInput = document.getElementById('join-family-id');
    const familyIdDisplay = document.getElementById('family-id-display');
    const budgetInput = document.getElementById('monthly-budget');
    const totalSpentEl = document.getElementById('total-spent');
    const remainingBudgetEl = document.getElementById('remaining-budget');
    const remainingLabel = document.getElementById('remaining-label');
    const progressBar = document.getElementById('progress-bar');
    const expenseForm = document.getElementById('add-expense-form');
    const amountInput = document.getElementById('expense-amount');
    const storeInput = document.getElementById('expense-store');
    const paymentMethodSelect = document.getElementById('payment-method');
    const expenseListEl = document.getElementById('expense-list');
    
    // --- ESTADO Y REFERENCIAS ---
    let unsubscribeBudget = () => {};
    let unsubscribeExpenses = () => {};
    let familyId = localStorage.getItem('familyId');
    const copFormatter = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });

    // --- FUNCIONES ---
    
    async function stringToSHA256(str) {
        const encoder = new TextEncoder();
        const data = encoder.encode(str);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function updateUI(budget = 0, expenses = []) {
        budgetInput.value = budget;
        const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
        totalSpentEl.textContent = copFormatter.format(totalExpenses);
        const remaining = budget - totalExpenses;
        if (remaining < 0) {
            remainingLabel.textContent = "Sobrepasado:";
            remainingBudgetEl.textContent = copFormatter.format(Math.abs(remaining));
            remainingBudgetEl.className = 'font-bold text-2xl text-red-500';
        } else {
            remainingLabel.textContent = "Restante:";
            remainingBudgetEl.textContent = copFormatter.format(remaining);
            remainingBudgetEl.className = 'font-bold text-2xl text-green-400';
        }
        const progressPercentage = budget > 0 ? (totalExpenses / budget) * 100 : 0;
        progressBar.style.width = `${Math.min(progressPercentage, 100)}%`;
        
        expenseListEl.innerHTML = '';
        if (expenses.length === 0) { expenseListEl.innerHTML = '<p class="text-slate-500 text-center">No hay gastos.</p>'; return; }
        expenses.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        expenses.forEach(expense => {
            const expenseEl = document.createElement('div');
            const date = expense.createdAt ? expense.createdAt.toDate() : new Date();
            expenseEl.className = 'bg-slate-900/50 p-3 rounded-lg flex justify-between items-center';
            expenseEl.innerHTML = `<div><p class="font-semibold">${expense.store}</p><p class="text-xs text-slate-400">${date.toLocaleDateString('es-CO')}</p></div><p class="font-bold">${copFormatter.format(expense.amount)}</p>`;
            expenseListEl.appendChild(expenseEl);
        });
    }

    function setupApp(currentFamilyId) {
        familyId = currentFamilyId;
        localStorage.setItem('familyId', familyId);
        familyIdDisplay.textContent = familyId;
        authContainer.classList.add('hidden');
        familyContainer.classList.add('hidden');
        appContainer.classList.remove('hidden');

        const budgetRef = doc(db, `families/${familyId}/budget/doc`);
        const expensesRef = collection(db, `families/${familyId}/expenses`);

        unsubscribeBudget = onSnapshot(budgetRef, (doc) => {
            const budget = doc.exists() ? doc.data().value : 0;
            updateUI(budget, []); // Update budget first
        });
        unsubscribeExpenses = onSnapshot(expensesRef, (snapshot) => {
            const expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const budget = parseFloat(budgetInput.value) || 0;
            updateUI(budget, expenses);
        });

        budgetInput.onchange = () => setDoc(budgetRef, { value: parseFloat(budgetInput.value) || 0 });
        expenseForm.onsubmit = async (e) => {
            e.preventDefault();
            await addDoc(expensesRef, { amount: parseFloat(amountInput.value) || 0, store: storeInput.value, paymentMethod: paymentMethodSelect.value, createdAt: serverTimestamp() });
            expenseForm.reset();
        };
    }

    // --- MANEJO DE AUTH ---
    onAuthStateChanged(auth, async (user) => {
        unsubscribeBudget();
        unsubscribeExpenses();
        if (user) {
            familyUserEmail.textContent = user.email;
            if (familyId) {
                setupApp(familyId);
            } else {
                authContainer.classList.add('hidden');
                familyContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        } else {
            authContainer.classList.remove('hidden');
            familyContainer.classList.add('hidden');
            appContainer.classList.add('hidden');
            localStorage.removeItem('familyId');
        }
    });

    createFamilyBtn.onclick = async () => {
        const newFamilyId = (await stringToSHA256(auth.currentUser.uid + Date.now())).substring(0, 8);
        setupApp(newFamilyId);
    };

    joinFamilyForm.onsubmit = (e) => {
        e.preventDefault();
        const enteredId = joinFamilyIdInput.value.trim();
        if (enteredId) setupApp(enteredId);
    };
    
    logoutBtn.onclick = () => signOut(auth);

    loginForm.onsubmit = async (e) => {
        e.preventDefault();
        const email = loginEmailInput.value;
        const password = loginPasswordInput.value;
        const isRegistering = loginForm.querySelector('h3').textContent.includes('Registrar');
        try {
            await (isRegistering ? createUserWithEmailAndPassword(auth, email, password) : signInWithEmailAndPassword(auth, email, password));
            authErrorEl.textContent = '';
        } catch (error) {
            authErrorEl.textContent = 'Error: ' + error.code.split('/')[1];
        }
    };
    
    showRegisterLink.onclick = (e) => {
        e.preventDefault();
        const h3 = loginForm.querySelector('h3');
        h3.textContent = h3.textContent.includes('Iniciar') ? 'Registrar Cuenta' : 'Iniciar Sesión';
        loginForm.querySelector('button').textContent = h3.textContent.includes('Registrar') ? 'Registrar' : 'Entrar';
        e.target.textContent = h3.textContent.includes('Registrar') ? 'Inicia sesión' : 'Regístrate';
    };
    
</script>

</body>
</html>
